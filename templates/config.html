<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings â€“ Myra Language Teacher</title>
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
  <link rel="stylesheet" href="/static/css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&family=Nunito:wght@400;600;700;900&display=swap" rel="stylesheet" />
</head>
<body class="settings-page">

<header>
  <div class="header-inner">
    <a href="/" class="back-btn">â† Back</a>
    <h1>âš™ï¸ Settings</h1>
    <span></span>
  </div>
</header>

<main class="settings-main">

  <div class="settings-card">

    <h2>ğŸ‘¶ Child's Name</h2>
    <input type="text" id="child-name" class="text-input"
           value="{{ config.child_name }}" placeholder="e.g. Myra" />

    <hr />

    <h2>ğŸ—£ï¸ Language to Teach</h2>
    <p class="hint">Select one language to practice.</p>
    <div class="checkbox-group">
      <label class="checkbox-label">
        <input type="radio" name="language" id="lang-telugu" value="telugu"
               {% if config.languages and config.languages[0] == 'telugu' %}checked{% endif %} />
        <span>Telugu</span>
        <span class="lang-sample">à°¤à±†à°²à±à°—à±</span>
      </label>
      <label class="checkbox-label">
        <input type="radio" name="language" id="lang-assamese" value="assamese"
               {% if config.languages and config.languages[0] == 'assamese' %}checked{% endif %} />
        <span>Assamese</span>
        <span class="lang-sample">à¦…à¦¸à¦®à§€à¦¯à¦¼à¦¾</span>
      </label>
    </div>

    <hr />

    <h2>ğŸ“š Word Categories</h2>
    <p class="hint">Choose which topics to practice.</p>
    <div class="checkbox-group categories-group">
      {% set category_labels = {
          'animals': 'ğŸ¾ Animals',
          'colors': 'ğŸ¨ Colors',
          'body_parts': 'ğŸ¤š Body Parts',
          'numbers': 'ğŸ”¢ Numbers',
          'food': 'ğŸ Food',
          'common_objects': 'ğŸ  Common Objects'
      } %}
      {% for cat in all_categories %}
      <label class="checkbox-label">
        <input type="checkbox" class="cat-checkbox" value="{{ cat }}"
               {% if cat in config.categories %}checked{% endif %} />
        <span>{{ category_labels.get(cat, cat.replace('_', ' ').title()) }}</span>
      </label>
      {% endfor %}
    </div>

    <hr />

    <h2>ğŸ›ï¸ Advanced Options</h2>

    <div class="option-row">
      <label for="show-romanized">Show pronunciation guide (romanized)</label>
      <input type="checkbox" id="show-romanized"
             {% if config.show_romanized %}checked{% endif %} />
    </div>

    <div class="option-row">
      <label for="similarity-threshold">
        Accuracy required: <strong id="threshold-label">{{ config.similarity_threshold }}%</strong>
      </label>
      <input type="range" id="similarity-threshold"
             min="30" max="90" step="5"
             value="{{ config.similarity_threshold }}"
             oninput="document.getElementById('threshold-label').textContent = this.value + '%'" />
    </div>

    <div class="option-row">
      <label for="max-attempts">Max attempts before auto-skip</label>
      <select id="max-attempts" class="select-input">
        {% for n in [2, 3, 4, 5] %}
        <option value="{{ n }}" {% if config.max_attempts == n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
    </div>

    <hr />

    <div class="btn-row centered">
      <button class="btn btn-play" onclick="saveSettings()">ğŸ’¾ Save Settings</button>
      <a href="/" class="btn btn-skip">ğŸ  Go Home</a>
    </div>

    <div id="save-feedback" class="feedback-banner hidden success">âœ… Settings saved!</div>

  </div><!-- end settings-card -->

</main>

<script>
const CONFIG_KEY = 'myra_config';

document.addEventListener('DOMContentLoaded', () => {
  const stored = localStorage.getItem(CONFIG_KEY);

  if (stored) {
    // Returning user: populate form from localStorage (overrides server-rendered defaults)
    const cfg = JSON.parse(stored);

    const childName = document.getElementById('child-name');
    if (childName && cfg.child_name) childName.value = cfg.child_name;

    // Set the single language radio button (use first element if array)
    const lang = Array.isArray(cfg.languages) ? cfg.languages[0] : cfg.languages;
    if (lang) {
      // First clear all radios, then check the stored one
      document.querySelectorAll('input[name="language"]').forEach(r => r.checked = false);
      const rb = document.querySelector(`input[name="language"][value="${lang}"]`);
      if (rb) rb.checked = true;
    }

    if (cfg.categories) {
      document.querySelectorAll('.cat-checkbox').forEach(cb => {
        cb.checked = cfg.categories.includes(cb.value);
      });
    }
    if (typeof cfg.show_romanized === 'boolean') {
      const sr = document.getElementById('show-romanized');
      if (sr) sr.checked = cfg.show_romanized;
    }
    if (cfg.similarity_threshold != null) {
      const st = document.getElementById('similarity-threshold');
      const label = document.getElementById('threshold-label');
      if (st) st.value = cfg.similarity_threshold;
      if (label) label.textContent = cfg.similarity_threshold + '%';
    }
    if (cfg.max_attempts != null) {
      const ma = document.getElementById('max-attempts');
      if (ma) ma.value = String(cfg.max_attempts);
    }
  } else {
    // New user: clear all server-rendered defaults so they must choose their own settings
    document.getElementById('child-name').value = '';
    document.querySelectorAll('input[name="language"]').forEach(r => r.checked = false);
    document.querySelectorAll('.cat-checkbox').forEach(cb => cb.checked = false);

    // Update header and hide nav links so they can't skip setup
    const h1 = document.querySelector('h1');
    if (h1) h1.textContent = 'ğŸ‘‹ Welcome! Set Up Your App';
    document.querySelector('.back-btn').style.display = 'none';
    document.querySelector('a.btn-skip').style.display = 'none';
  }
});

async function saveSettings() {
  const childNameVal = document.getElementById('child-name').value.trim();
  if (!childNameVal) {
    alert("Please enter the child's name!");
    return;
  }

  const selectedLang = document.querySelector('input[name="language"]:checked');
  if (!selectedLang) {
    alert('Please select a language!');
    return;
  }

  const categories = [];
  document.querySelectorAll('.cat-checkbox').forEach(cb => {
    if (cb.checked) categories.push(cb.value);
  });
  if (categories.length === 0) {
    alert('Please select at least one category!');
    return;
  }

  const config = {
    child_name: childNameVal,
    languages: [selectedLang.value],
    categories,
    show_romanized: document.getElementById('show-romanized').checked,
    similarity_threshold: parseInt(document.getElementById('similarity-threshold').value),
    max_attempts: parseInt(document.getElementById('max-attempts').value),
    setup_complete: true,
  };

  let resp;
  try {
    resp = await fetch('/api/config', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(config),
    });
  } catch (err) {
    alert(`Network error â€“ could not reach server.\n${err.message}`);
    return;
  }

  if (resp.ok) {
    localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
    const fb = document.getElementById('save-feedback');
    fb.classList.remove('hidden');
    setTimeout(() => { fb.classList.add('hidden'); window.location.href = '/'; }, 1500);
  } else {
    let detail = '';
    try {
      const body = await resp.json();
      detail = body.detail || JSON.stringify(body);
    } catch (_) {
      detail = await resp.text().catch(() => '');
    }
    alert(`Save failed (HTTP ${resp.status})${detail ? ':\n' + detail : '.'}`);
  }
}
</script>
</body>
</html>
