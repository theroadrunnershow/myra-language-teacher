<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings â€“ Myra Language Teacher</title>
  <link rel="stylesheet" href="/static/css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet" />
</head>
<body class="settings-page">

<header>
  <div class="header-inner">
    <a href="/" class="back-btn">â† Back</a>
    <h1>âš™ï¸ Settings</h1>
    <span></span>
  </div>
</header>

<main class="settings-main">

  <div class="settings-card">

    <h2>ğŸ‘¶ Child's Name</h2>
    <input type="text" id="child-name" class="text-input"
           value="{{ config.child_name }}" placeholder="e.g. Myra" />

    <hr />

    <h2>ğŸ—£ï¸ Languages to Teach</h2>
    <p class="hint">Select one or both â€” the app will alternate randomly.</p>
    <div class="checkbox-group">
      <label class="checkbox-label">
        <input type="checkbox" id="lang-telugu" value="telugu"
               {% if 'telugu' in config.languages %}checked{% endif %} />
        <span>Telugu</span>
        <span class="lang-sample">à°¤à±†à°²à±à°—à±</span>
      </label>
      <label class="checkbox-label">
        <input type="checkbox" id="lang-assamese" value="assamese"
               {% if 'assamese' in config.languages %}checked{% endif %} />
        <span>Assamese</span>
        <span class="lang-sample">à¦…à¦¸à¦®à§€à¦¯à¦¼à¦¾</span>
      </label>
    </div>

    <hr />

    <h2>ğŸ“š Word Categories</h2>
    <p class="hint">Choose which topics to practice.</p>
    <div class="checkbox-group categories-group">
      {% set category_labels = {
          'animals': 'ğŸ¾ Animals',
          'colors': 'ğŸ¨ Colors',
          'body_parts': 'ğŸ¤š Body Parts',
          'numbers': 'ğŸ”¢ Numbers',
          'food': 'ğŸ Food',
          'common_objects': 'ğŸ  Common Objects'
      } %}
      {% for cat in all_categories %}
      <label class="checkbox-label">
        <input type="checkbox" class="cat-checkbox" value="{{ cat }}"
               {% if cat in config.categories %}checked{% endif %} />
        <span>{{ category_labels.get(cat, cat.replace('_', ' ').title()) }}</span>
      </label>
      {% endfor %}
    </div>

    <hr />

    <h2>ğŸ›ï¸ Advanced Options</h2>

    <div class="option-row">
      <label for="show-romanized">Show pronunciation guide (romanized)</label>
      <input type="checkbox" id="show-romanized"
             {% if config.show_romanized %}checked{% endif %} />
    </div>

    <div class="option-row">
      <label for="similarity-threshold">
        Accuracy required: <strong id="threshold-label">{{ config.similarity_threshold }}%</strong>
      </label>
      <input type="range" id="similarity-threshold"
             min="30" max="90" step="5"
             value="{{ config.similarity_threshold }}"
             oninput="document.getElementById('threshold-label').textContent = this.value + '%'" />
    </div>

    <div class="option-row">
      <label for="max-attempts">Max attempts before auto-skip</label>
      <select id="max-attempts" class="select-input">
        {% for n in [2, 3, 4, 5] %}
        <option value="{{ n }}" {% if config.max_attempts == n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
    </div>

    <hr />

    <h2>ğŸ¤– Reachy Mini Robot</h2>
    <p class="hint">When enabled, audio plays through the robot's speaker and the robot dances on correct/wrong answers.</p>

    <div class="option-row">
      <label for="reachy-enabled">Enable Reachy Mini integration</label>
      <input type="checkbox" id="reachy-enabled"
             {% if config.get('reachy_enabled') %}checked{% endif %} />
    </div>

    <div id="reachy-settings" class="reachy-settings-group" style="display:none">
      <div class="option-row">
        <label for="reachy-host">Robot IP address or hostname</label>
        <input type="text" id="reachy-host" class="text-input"
               value="{{ config.get('reachy_host', 'reachy.local') }}"
               placeholder="e.g. 192.168.1.42 or reachy.local" />
      </div>

      <div class="option-row">
        <label for="reachy-username">SSH username</label>
        <input type="text" id="reachy-username" class="text-input"
               value="{{ config.get('reachy_username', 'bedrock') }}"
               placeholder="bedrock" />
      </div>

      <div class="option-row">
        <label for="reachy-password">SSH password</label>
        <input type="password" id="reachy-password" class="text-input"
               placeholder="Leave blank to keep saved password" />
      </div>

      <div class="btn-row">
        <button class="btn btn-skip" onclick="testReachyConnection()">ğŸ”Œ Test Connection</button>
        <span id="reachy-status" class="reachy-status"></span>
      </div>
    </div>

    <hr />

    <div class="btn-row centered">
      <button class="btn btn-play" onclick="saveSettings()">ğŸ’¾ Save Settings</button>
      <a href="/" class="btn btn-skip">ğŸ  Go Home</a>
    </div>

    <div id="save-feedback" class="feedback-banner hidden success">âœ… Settings saved!</div>

  </div><!-- end settings-card -->

</main>

<script>
const CONFIG_KEY = 'myra_config';

// Populate form from sessionStorage on load (overrides server defaults)
document.addEventListener('DOMContentLoaded', () => {
  const stored = sessionStorage.getItem(CONFIG_KEY);
  if (stored) {
    const cfg = JSON.parse(stored);
    const childName = document.getElementById('child-name');
    if (childName && cfg.child_name) childName.value = cfg.child_name;
    if (cfg.languages) {
      cfg.languages.forEach(lang => {
        const cb = document.getElementById('lang-' + lang);
        if (cb) cb.checked = true;
      });
      ['telugu','assamese'].forEach(lang => {
        if (!(cfg.languages || []).includes(lang)) {
          const cb = document.getElementById('lang-' + lang);
          if (cb) cb.checked = false;
        }
      });
    }
    if (cfg.categories) {
      document.querySelectorAll('.cat-checkbox').forEach(cb => {
        cb.checked = cfg.categories.includes(cb.value);
      });
    }
    if (typeof cfg.show_romanized === 'boolean') {
      const sr = document.getElementById('show-romanized');
      if (sr) sr.checked = cfg.show_romanized;
    }
    if (cfg.similarity_threshold != null) {
      const st = document.getElementById('similarity-threshold');
      const label = document.getElementById('threshold-label');
      if (st) st.value = cfg.similarity_threshold;
      if (label) label.textContent = cfg.similarity_threshold + '%';
    }
    if (cfg.max_attempts != null) {
      const ma = document.getElementById('max-attempts');
      if (ma) ma.value = String(cfg.max_attempts);
    }

    // Reachy settings
    if (typeof cfg.reachy_enabled === 'boolean') {
      const re = document.getElementById('reachy-enabled');
      if (re) re.checked = cfg.reachy_enabled;
    }
    if (cfg.reachy_host) {
      const rh = document.getElementById('reachy-host');
      if (rh) rh.value = cfg.reachy_host;
    }
    if (cfg.reachy_username) {
      const ru = document.getElementById('reachy-username');
      if (ru) ru.value = cfg.reachy_username;
    }
  }

  // Show/hide Reachy settings group based on checkbox
  const reachyCb = document.getElementById('reachy-enabled');
  const reachyGroup = document.getElementById('reachy-settings');
  if (reachyCb && reachyGroup) {
    reachyGroup.style.display = reachyCb.checked ? '' : 'none';
    reachyCb.addEventListener('change', () => {
      reachyGroup.style.display = reachyCb.checked ? '' : 'none';
    });
  }

  // Show live connection status on load
  fetchReachyStatus();
});

async function fetchReachyStatus() {
  try {
    const resp = await fetch('/api/reachy/status');
    const st = await resp.json();
    updateReachyStatusBadge(st);
  } catch (_) { /* server might not have the endpoint yet */ }
}

function updateReachyStatusBadge(st) {
  const el = document.getElementById('reachy-status');
  if (!el) return;
  if (st.connected) {
    el.textContent = `âœ… Connected to ${st.host}`;
    el.style.color = '#2ecc71';
  } else {
    el.textContent = 'âš« Not connected';
    el.style.color = '#aaa';
  }
}

async function testReachyConnection() {
  const host = document.getElementById('reachy-host').value.trim();
  const username = document.getElementById('reachy-username').value.trim() || 'bedrock';
  const password = document.getElementById('reachy-password').value;

  if (!host) {
    alert('Please enter the robot IP address or hostname.');
    return;
  }

  const statusEl = document.getElementById('reachy-status');
  statusEl.textContent = 'ğŸ”„ Connectingâ€¦';
  statusEl.style.color = '#f39c12';

  try {
    const resp = await fetch('/api/reachy/connect', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ host, username, password }),
    });
    const st = await resp.json();

    if (st.connected) {
      const parts = [];
      if (st.sdk_connected) parts.push('arm control');
      if (st.ssh_connected) parts.push('audio');
      statusEl.textContent = `âœ… Connected! (${parts.join(', ')})`;
      statusEl.style.color = '#2ecc71';
    } else {
      const errs = (st.errors || []).join('; ');
      statusEl.textContent = `âŒ Failed: ${errs || 'Could not reach robot'}`;
      statusEl.style.color = '#e74c3c';
    }
  } catch (err) {
    statusEl.textContent = `âŒ Error: ${err.message}`;
    statusEl.style.color = '#e74c3c';
  }
}

async function saveSettings() {
  const languages = [];
  document.querySelectorAll('input[type=checkbox][id^="lang-"]').forEach(cb => {
    if (cb.checked) languages.push(cb.value);
  });

  const categories = [];
  document.querySelectorAll('.cat-checkbox').forEach(cb => {
    if (cb.checked) categories.push(cb.value);
  });

  if (languages.length === 0) {
    alert('Please select at least one language!');
    return;
  }
  if (categories.length === 0) {
    alert('Please select at least one category!');
    return;
  }

  const reachyEnabled = document.getElementById('reachy-enabled').checked;
  const reachyHost = document.getElementById('reachy-host').value.trim();
  const reachyUsername = document.getElementById('reachy-username').value.trim() || 'bedrock';
  const reachyPasswordRaw = document.getElementById('reachy-password').value;

  // Read existing stored password so we don't wipe it when field is blank
  const storedCfg = JSON.parse(sessionStorage.getItem(CONFIG_KEY) || '{}');
  const reachyPassword = reachyPasswordRaw || storedCfg.reachy_password || 'bedrock';

  const config = {
    child_name: document.getElementById('child-name').value.trim() || 'Myra',
    languages,
    categories,
    show_romanized: document.getElementById('show-romanized').checked,
    similarity_threshold: parseInt(document.getElementById('similarity-threshold').value),
    max_attempts: parseInt(document.getElementById('max-attempts').value),
    reachy_enabled: reachyEnabled,
    reachy_host: reachyHost || 'reachy.local',
    reachy_username: reachyUsername,
    reachy_password: reachyPassword,
  };

  const resp = await fetch('/api/config', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(config),
  });

  if (resp.ok) {
    sessionStorage.setItem(CONFIG_KEY, JSON.stringify(config));

    // If Reachy just got enabled, connect now
    if (reachyEnabled && reachyHost) {
      const statusEl = document.getElementById('reachy-status');
      statusEl.textContent = 'ğŸ”„ Connecting to robotâ€¦';
      statusEl.style.color = '#f39c12';
      try {
        const cr = await fetch('/api/reachy/connect', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ host: reachyHost, username: reachyUsername, password: reachyPassword }),
        });
        const st = await cr.json();
        updateReachyStatusBadge(st);
      } catch (_) {}
    }

    const fb = document.getElementById('save-feedback');
    fb.classList.remove('hidden');
    setTimeout(() => fb.classList.add('hidden'), 2500);
  } else {
    alert('Save failed â€“ check the server console.');
  }
}
</script>
</body>
</html>
